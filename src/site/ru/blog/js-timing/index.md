---
layout: article
tags: [articles, ru]
date: 2020-05-10
title: Считаем время в JavaScript
description: Почему расчёт длительности с помощью Date.now может привести к неожиданным результатам и как этого избежать
---
Во фронтенде встречаются задачи, требующие измерения времени: например, расчёт длительности загрузки какого-либо ресурса или расчёт прогресса анимации.

Велик соблазн использовать для расчёта `Date.now`:

```js
const start = Date.now();
const result = await fetch('/data');

console.log('Elapsed time in milliseconds:', Date.now() - start);
```

Казалось бы, задача решена и можно отправляться пить кофе. Но есть нюанс: вычисленная таким способом длительность может оказаться отрицательной.

## Что не так с Date.now?

Главные проблемы функции `Date.now` в контексте описанной задачи:

1. `Date.now` не [монотонна](https://ru.wikipedia.org/wiki/Монотонная_функция), то есть она может как возрастать, так и убывать (это и приводит к получению отрицательных длительностей в вычислениях).
2. Она не гарантирует равномерность роста возвращаемых значений.

Корень этих проблем в том, что `Date` и его функции используют системные часы, которые подвержены внешним воздействиям:

* системное время может быть изменено пользователем;
* службы операционной системы регулярно [синхронизируют время c точными часами через интернет](https://ru.wikipedia.org/wiki/NTP), что может приводить к скачкам, если локальные часы сильно отстали или наоборот ушли вперёд.

## Что использовать вместо Date.now?

### В браузере

В спецификации [High Resolution Time](https://www.w3.org/TR/hr-time) описана функция `performance.now`, которая не только решает озвученные проблемы, но и повышает точность измерений до микросекунд ([в зависимости от браузера](https://github.com/w3c/hr-time/issues/56)). Подробнее о ней можно прочитать в самой спецификации или [на MDN](https://developer.mozilla.org/en-US/docs/Web/API/Performance/now).

### В Node.js

Node.js предоставляет функции [`process.hrtime`](https://nodejs.org/api/process.html#process_process_hrtime_time) и [`process.hrtime.bigint`](https://nodejs.org/api/process.html#process_process_hrtime_bigint), которые тоже не зависят от системных часов и повышают точность измерений до наносекунд.
